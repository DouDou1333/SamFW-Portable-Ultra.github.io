<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SamFW Portable Ultra</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <style>
        :root { --main-color: #00ff41; --bg-color: #050505; }
        body { margin: 0; padding: 15px; background: var(--bg-color); color: var(--main-color); font-family: 'Courier New', monospace; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        h2 { text-align: center; margin-top: 0; font-size: 1.2rem; border-bottom: 1px solid var(--main-color); padding-bottom: 10px; }
        #terminal { flex-grow: 1; border: 1px solid var(--main-color); background: #000; padding: 10px; overflow-y: auto; font-size: 0.9rem; margin-bottom: 15px; border-radius: 4px; }
        .log-entry { margin-bottom: 5px; word-wrap: break-word; }
        .log-error { color: #ff3333; }
        .log-success { color: #ffff00; }
        button { background: var(--bg-color); color: var(--main-color); border: 2px solid var(--main-color); padding: 15px; font-size: 1rem; font-weight: bold; cursor: pointer; border-radius: 4px; transition: 0.2s; text-transform: uppercase; }
        button:hover, button:active { background: var(--main-color); color: #000; }
        button:disabled { border-color: #333; color: #555; cursor: not-allowed; }
    </style>
</head>
<body>

    <h2>SAMFW PORTABLE ULTRA</h2>
    
    <div id="terminal">
        <div class="log-entry">INITIALISATION DU SYSTÃˆME...</div>
    </div>

    <button id="btnConnect">ðŸ”Œ Connecter Appareil USB</button>

    <script>
        const terminal = document.getElementById('terminal');
        const btnConnect = document.getElementById('btnConnect');

        // Fonction pour Ã©crire dans le terminal
        function logMsg(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = `log-entry ${type === 'error' ? 'log-error' : type === 'success' ? 'log-success' : ''}`;
            const time = new Date().toLocaleTimeString('fr-FR');
            div.textContent = `[${time}] > ${msg}`;
            terminal.appendChild(div);
            terminal.scrollTop = terminal.scrollHeight; // Auto-scroll
        }

        // 1. VÃ©rification de la compatibilitÃ© WebUSB
        if (!('usb' in navigator)) {
            logMsg("ERREUR CRITIQUE: WebUSB n'est pas supportÃ© sur ce navigateur. Utilisez Chrome ou Edge.", "error");
            btnConnect.disabled = true;
            btnConnect.textContent = "Navigateur Incompatible";
        } else {
            logMsg("Module WebUSB : DÃ‰TECTÃ‰ ET ACTIF", "success");
        }

        // 2. Gestion de la connexion USB
        btnConnect.addEventListener('click', async () => {
            try {
                logMsg("Attente de la sÃ©lection de l'appareil...");
                // Demande l'accÃ¨s Ã  n'importe quel appareil USB (tu pourras filtrer les vendorId plus tard)
                const device = await navigator.usb.requestDevice({ filters: [] });
                
                logMsg(`Appareil sÃ©lectionnÃ©: ${device.productName || 'Appareil inconnu'}`, "info");
                
                await device.open();
                logMsg("Session USB ouverte.", "info");
                
                // SÃ©lection de la configuration par dÃ©faut si nÃ©cessaire
                if (device.configuration === null) {
                    await device.selectConfiguration(1);
                    logMsg("Configuration 1 sÃ©lectionnÃ©e.", "info");
                }
                
                // RÃ©clamation de l'interface (nÃ©cessaire pour communiquer)
                await device.claimInterface(0);
                logMsg(`CONNEXION Ã‰TABLIE AVEC SUCCÃˆS : ${device.manufacturerName} ${device.productName}`, "success");

            } catch (error) {
                // Gestion fine des erreurs (ex: l'utilisateur a annulÃ©)
                if (error.name === 'NotFoundError') {
                    logMsg("Action annulÃ©e par l'utilisateur.", "error");
                } else if (error.name === 'SecurityError') {
                    logMsg("Erreur de sÃ©curitÃ©. Assurez-vous d'Ãªtre en HTTPS.", "error");
                } else {
                    logMsg(`Ã‰chec de connexion: ${error.message}`, "error");
                }
            }
        });

        // 3. Enregistrement du Service Worker (Pour le mode PWA/Hors-ligne)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => logMsg("Service Worker enregistrÃ© (Mode hors-ligne actif)."))
                    .catch(err => logMsg(`Erreur Service Worker: ${err}`, "error"));
            });
        }
    </script>
</body>
</html>
